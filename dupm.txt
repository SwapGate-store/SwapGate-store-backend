const express = require("express");
const axios = require("axios");

const app = express();
app.use(express.json());

const BOT_TOKEN = "8244783809:AAESM8DUsV9goMRYbGCjZxUtyYkw6UUtP_0";
const CHAT_ID = "5734946501";

app.post("/send-msg", async (req, res) => {
  const { name, time, amount, binanceId } = req.body;

  if (!name || !time || !amount || !binanceId) {
    return res.status(400).json({ success: false, error: "All fields are required" });
  }

  const textMessage = `Name: ${name}\nTime: ${time}\nAmount: ${amount}\nBinance ID: ${binanceId}`;

  try {
    const response = await axios.post(
      `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,
      { chat_id: CHAT_ID, text: textMessage }
    );

    res.json({ success: true, data: response.data });
  } catch (err) {
    res.status(500).json({ success: false, error: err.message });
  }
});

app.listen(3000, () => console.log("Server running on port 3000"));



// ...existing code...
const express = require("express");
const axios = require("axios");
const multer = require("multer");
const FormData = require("form-data");
const fs = require("fs");
const swaggerUi = require("swagger-ui-express");
const swaggerJsdoc = require("swagger-jsdoc");
const cors = require("cors");



const app = express();
app.use(cors({
  origin: ["*", "http://localhost", "http://127.0.0.1"],
  methods: ["GET", "POST", "PUT", "DELETE"],
}));
app.use(express.json());

const swaggerOptions = {
  definition: {
    openapi: "3.0.0",
    info: {
      title: "Telegram BotFather API",
      version: "1.0.0",
      description: "API to send a photo to Telegram bot",
    },
  },
  apis: [__filename],
};

const swaggerSpec = swaggerJsdoc(swaggerOptions);
app.use("/api-docs", swaggerUi.serve, swaggerUi.setup(swaggerSpec));

const BOT_TOKEN = "8244783809:AAESM8DUsV9goMRYbGCjZxUtyYkw6UUtP_0";
const CHAT_ID = "5734946501";

/**
 * @openapi
 * /api/health:
 *   get:
 *     summary: Health check endpoint
 *     responses:
 *       200:
 *         description: Backend is healthy
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 status:
 *                   type: string
 *                   example: ok
 */
app.get("/api/health", (req, res) => {
  res.json({ status: "ok" });
});
/**
 * @openapi
 * /api/send-msg:
 *   post:
 *     summary: Send message and photo to Telegram bot
 *     requestBody:
 *       required: true
 *       content:
 *         multipart/form-data:
 *           schema:
 *             type: object
 *             properties:
 *               username:
 *                 type: string
 *               user_mobile_no:
 *                 type: string
 *               exchange_name:
 *                 type: string
 *               exchange_id:
 *                 type: string
 *               usdt_amount:
 *                 type: number
 *               lkr_amount:
 *                 type: number
 *               selected_bank_name:
 *                 type: string
 *               receipt:
 *                 type: string
 *                 format: binary
 *     responses:
 *       200:
 *         description: Message and photo sent successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 telegram:
 *                   type: object
 *       500:
 *         description: Error sending message/photo
 */
const upload = multer({ dest: "uploads/" });
const path = require("path");
app.post("/api/send-msg", upload.single("receipt"), async (req, res) => {
  try {
    const {
      username,
      user_mobile_no,
  // user_mobile_no is already declared above, remove duplicate
      exchange_name,
      exchange_id,
      usdt_amount,
      lkr_amount,
      selected_bank_name
    } = req.body;
    const filePath = req.file ? req.file.path : null;
    if (!username || !user_mobile_no || !exchange_name || !exchange_id || !usdt_amount || !lkr_amount || !selected_bank_name || !filePath) {
      return res.status(400).json({ success: false, error: "All fields are required" });
    }

    const now = new Date();
    const timeString = now.toLocaleString();
    const caption =
      `Receipt: ${req.file.originalname}\n` +
      `Time: ${timeString}\n` +
      `Name: ${username}\n` +
      `Mobile No: ${user_mobile_no}\n` +
      `Amount: ${usdt_amount} USDT / ${lkr_amount} LKR\n` +
      `Exchange Name: ${exchange_name}`;

    const form = new FormData();
    form.append("chat_id", CHAT_ID);
    form.append("caption", caption);

    // Check file type: send as photo if image, else as document (PDF)
    const mimeType = req.file.mimetype;
    let telegramResponse;
    if (mimeType.startsWith("image/")) {
      form.append("photo", fs.createReadStream(filePath));
      telegramResponse = await axios.post(
        `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,
        form,
        { headers: form.getHeaders() }
      );
    } else if (mimeType === "application/pdf") {
      // Rename PDF file using customer details
      const safeUsername = username.replace(/[^a-zA-Z0-9-_]/g, "_");
  const safeDate = now.toISOString().replace(/[:.]/g, "-");
  const newFilename = `${safeUsername}_${safeDate}_exchange_${exchange_id}_usdt_${usdt_amount}_lkr_${lkr_amount}.pdf`;
      const newFilePath = path.join(path.dirname(filePath), newFilename);
      fs.renameSync(filePath, newFilePath);
      form.append("document", fs.createReadStream(newFilePath), { filename: newFilename });
      telegramResponse = await axios.post(
        `https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`,
        form,
        { headers: form.getHeaders() }
      );
    } else {
      return res.status(400).json({ success: false, error: "Unsupported file type. Please upload an image or PDF." });
    }

    // Send Exchange ID as a separate message for easy copying
    await axios.post(
      `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,
      {
        chat_id: CHAT_ID,
        text: `Exchange ID: ${exchange_id}`
      }
    );

    res.json({ success: true, telegram: telegramResponse.data });
  } catch (err) {
    res.status(500).json({ success: false, error: err.message });
  }
});

app.listen(3000, () => console.log("Server running on port 3000"));
